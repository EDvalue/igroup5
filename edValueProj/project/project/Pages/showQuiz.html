<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8" />
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <link href="../CSS/showQuiz.css" rel="stylesheet" />

    <script src="//cdn.ckeditor.com/4.14.0/standard/ckeditor.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <title></title>

    <script>

        var str;
        var el; //save the quiz object;
        var modeQuiz;//save the reason to open this page;
        var perform_showQuiz_mode;//save who is in the page;
        var LufDiv;//save the last element upload active;
        var userOBJ;//save the user that active in the page;

        function init() {
            
            if (localStorage["userMode"]) 
                perform_showQuiz_mode = localStorage["userMode"];
            
            if(localStorage['user'])
                userOBJ = JSON.parse(localStorage['user']);

            if(localStorage['quiz_mode'])
                modeQuiz = localStorage['quiz_mode'];

            quizString = "";
            document.getElementsByTagName('body')[0].innerHTML = ""

            if(localStorage['quiz'])
                el = JSON.parse(localStorage['quiz']);//read the quiz

            quizString += `<div id='QuizTitle'><h1>${el.Title}</h1> </div>
                                        <div id='main' dir="rtl"><form id=quizForm>`
            for (qu in el.Question) {
                //loop over the question in the quiz for print them;
                quizString += `<div question_id="${el.Question[qu].QuestionId}" num_question="${el.Question[qu].OrderNum}" id='${qu}' class="qu" Qtype='${el.Question[qu].Type}'>`
                if (el.Question[qu].ImgLink != "" || el.Question[qu].VideoLink != "") {
                    quizString += `<div id="extraData">`
                    if (el.Question[qu].ImgLink != "")
                        quizString += `<img src="${el.Question[qu].ImgLink}" />`
                    if (el.Question[qu].VideoLink != "") {

                        const videoId = getId(`${el.Question[qu].VideoLink}`);
                        const iframeMarkup = '<iframe width="560" height="315" src="//www.youtube.com/embed/'
                            + videoId + '" frameborder="0" allowfullscreen></iframe>';


                        quizString += iframeMarkup;
                    }

                    quizString += `</div>`
                }
                quizString += `<div  id="Question_content"><p>${el.Question[qu].Content}</p></div>`

                if (el.Question[qu].Type == 'A') {
                    quizString += `<div id="Question_answer">`
                    for (y in el.Question[qu].Answer) {
                        if (el.Question[qu].Answer[y].IsRight) {
                            quizString += `<div id="AmericanAmswerBlock">`
                            if (perform_showQuiz_mode == 'teacher') {

                                quizString += `<span>${parseInt(y) + 1}</span><input ansID="${el.Question[qu].Answer[y].AnsId}" type="checkbox" checked name="chk${qu}"/> <p>${el.Question[qu].Answer[y].Content}</p>`
                            } else {

                                quizString += `<span>${parseInt(y) + 1}</span><input ansID="${el.Question[qu].Answer[y].AnsId}" type="checkbox"  name="chk${qu}"/> <p>${el.Question[qu].Answer[y].Content}</p>`
                            }

                            quizString += `</div>`
                        } else {
                            quizString += `<div id="AmericanAmswerBlock">
                                                 <span>${parseInt(y) + 1}</span><input ansID="${el.Question[qu].Answer[y].AnsId}" type="checkbox"  name="chk${qu}"/> <p>${el.Question[qu].Answer[y].Content}</p>
                                                 </div>`
                        }

                    }

                    quizString += `</div>`;
                } else if (el.Question[qu].Type == 'O') {

                    quizString += `<div id="OpenAnswerBlock"><textarea class="ckeditor" id="ck${qu}"  name="editor" rows='7' cols='100' ></textarea></div>`


                } else if (el.Question[qu].Type == 'U') {

                    quizString += `<div id='OpenUploadBlock'>
                                        <div class='displayFile'><div name='file${qu}' class='filedrag' id='drag${qu}'></div><div class="loader"></div></div>
                                                <input type='file' accept=".xls,.xlsx,image/*,.pdf,.rar,.zip"  id='file${qu}' />
                                                <div id='upload-BTN'>
                                                   <input type='button' myFile='file${qu}' class='btn btn-primary upl' value='בחר קובץ' />
                                                   <input type='button' toSave='file${qu}' class='btn btn-info sf' value='שמור' />
                                                 </div>
                                            </div>`;

                } else if (el.Question[qu].Type == 'M') {

                    for (y in el.Question[qu].Answer) {

                        if (el.Question[qu].Answer[y].IsRight) {
                            quizString += `<div id="AmericanAmswerBlock">`
                            if (perform_showQuiz_mode == "teacher") {
                                quizString += `<span>${parseInt(y) + 1}</span><input ansID="${el.Question[qu].Answer[y].AnsId}" type="checkbox" checked /> <p>${el.Question[qu].Answer[y].Content}</p>`
                            } else {
                                quizString += `<span>${parseInt(y) + 1}</span><input ansID="${el.Question[qu].Answer[y].AnsId}" type="checkbox"  /> <p>${el.Question[qu].Answer[y].Content}</p>`
                            }

                            quizString += `</div>`
                        } else {
                            quizString += `<div id="AmericanAmswerBlock">
                                                 <span>${parseInt(y) + 1}</span><input type="checkbox" /> <p>${el.Question[qu].Answer[y].Content}</p>
                                                 </div>`
                        }

                    }


                }

                quizString += '</div>'

            }

            if (perform_showQuiz_mode == "student") {
                quizString += `<div id=submitDIV><button type="submit" class="btn btn-primary">הגש שאלון</button</div>`
            } else {
                //teacher note and grade
            }

            quizString += '</div></form>'
            document.getElementsByTagName('body')[0].innerHTML += quizString;
            $(".loader").hide();
            ckReplace()
            connectCHK();
            connectForm();
            if (perform_showQuiz_mode == "student" ||(perform_showQuiz_mode="teacher"&&modeQuiz=="check")) {
                //fill answer of quiz
                fillANS();
            }

        }

        function fileperform() {
            file = this;
            if (file.files[0].size > 2097152) {
                swal("File is too big!");
                this.value = "";
            } else {

                //$("#" + this.parentNode.id + " .dl").remove();
                if (file.value.split('.')[1] == "xlsx" || file.value.split('.')[1] == "xls") {
                    $("#" + this.parentNode.parentNode.id + ' .filedrag').html(`<img src="../images/excel-icon.png" />`)
                } else if (file.value.split('.')[1] == "pdf") {
                    $("#" + this.parentNode.parentNode.id + ' .filedrag').html(`<img src="../images/pdf-icon.jpg" />`)
                } else if (file.value.split('.')[1] == "docx") {
                    $("#" + this.parentNode.parentNode.id + ' .filedrag').html(`<img src="../images/word-icon.png" />`)
                } else if (file.value.split('.')[1] == "jpeg" || file.value.split('.')[1] == "jpg" || file.value.split('.')[1] == "png") {
                    $("#" + this.parentNode.parentNode.id + ' .filedrag').html(`<img src="" />`)

                    var demoImage = document.getElementById(this.parentNode.parentNode.id).querySelector('.filedrag').querySelector('img')


                    var reader = new FileReader();
                    reader.onload = function (event) {
                        demoImage.src = reader.result;
                    }
                    reader.readAsDataURL(file.files[0]);

                }
                else if (file.value.split('.')[1] == 'rar' || file.value.split('.')[1] == 'zip') {
                    $("#" + this.parentNode.parentNode.id + ' .filedrag').html(`<img src="../images/rar-icon.png" />`)

                }
            }
        }

        function fillANS() {
            //this function fill the ans of student; 
            for (q in el.Question) {

                if (el.Question[q].Type == 'O') {
                    if (el.Question[qu].Content !== null) {
                        CKEDITOR.instances[`ck${q}`].setData(el.Question[q].AnsContent)
                    }

                } else if (el.Question[q].Type == 'A' || el.Question[q].Type == 'M') {
                    chkArr = $(`#${q} input[type='checkbox']`);
                    for (a in el.Question[q].Answer) {
                        if (el.Question[q].Answer[a].IsPicked) {

                            $(chkArr[a]).prop("checked", true);
                        }
                    }
                } else if (el.Question[q].Type == 'U') {
                    if (el.Question[q].AnsContent) {
                        $(`#${q} #upload-BTN`).append(`<div class='link'>${el.Question[q].AnsContent}</div>`);
                        $(`#${q} #upload-BTN`).append(`<a class='dl' href="${el.Question[q].AnsContent}" download>הורד קובץ</a>`);

                        ext = el.Question[q].AnsContent.split('uploadedFile')[1].split('.')[1];
                        if (ext == "xlsx" || ext == "xls") {
                            $(`#${q} .filedrag`).html(`<img src="../images/excel-icon.png" />`);
                        } else if (ext == "docx") {
                            $(`#${q} .filedrag`).html(`<img src="../images/word-icon.png" />`);
                        } else if (ext == "pdf") {
                            $(`#${q} .filedrag`).html(`<img src="../images/pdf-icon.jpg" />`);
                        } else if (ext == "jpeg" || ext == "jpg" || ext == "png") {
                            $(`#${q} .filedrag`).html(`<img src="${el.Question[q].AnsContent}" />`);
                        } else if (ext == 'rar' || ext == 'zip') {
                            $(`#${q} .filedrag`).html(`<img src="../images/rar-icon.png" />`)

                        }
                    }

                }
            }
        }

        function connectForm() {

            if (modeQuiz != "watch") {

                window.onbeforeunload = function () {
                    return "אתה בטוח שאתה רוצה לעזוב בלי לשמור את השינויים?";
                  
                };

                $("#quizForm").submit(function () {
                    uploadeForm();
                    return false;
                });

                $("input[type='file']").change(fileperform)

                $('.upl').click(function () {
                    $('#' + $(this).attr('myFile')).trigger('click');
                });

                $('.sf').click(function () {
                    $('.loader').show();
                    var data = new FormData();
                    LufDiv = this.parentNode;
                    var file = $('#' + $(this).attr('toSave')).get(0).files[0];
                    data.append("UploadedFile", file);

                    $.ajax({
                        type: "POST",
                        url: "../api/upload/uploadFile",
                        contentType: false,
                        processData: false,
                        data: data,
                        success: PostDocSuccess,
                        error: PostDocError
                    });
                });

                //drag files

                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                daArr = $(".filedrag");//read all upload div in page;

                for (d = 0; d <= daArr.length; d++) {
                    //connect the file drag
                    $(daArr[d]).on('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.dataTransfer = e.originalEvent.dataTransfer
                        let fileInput = document.querySelector("#file" + e.target.parentNode.parentNode.parentNode.id);

                        for (const f of e.dataTransfer.files) {
                            console.log('File(s) you dragged here: ', f.path)
                            fileInput.files = e.dataTransfer.files;
                            $("#" + fileInput.id).trigger('change');
                        }
                    });

                    $(daArr[d]).on('dragover', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        $(".filedrag").css("borderColor", "#007bff")

                    });

                    $(daArr[d]).on('dragleave', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        $(".filedrag").css("borderColor", "#ccc")

                    });

                }
                //else disabled page if the user dont should create any change
                //in the quiz performing
            } else {$("#main *").prop('disabled', 'disabled')}
        }

        function PostDocSuccess(data) {
            //upload doc of student success
              $('.loader').hide();
            $(LufDiv).children('.link').remove();
            $(LufDiv).children('.dl').remove();

            $(LufDiv).append(`<div class='link'>${data}</div>`);
            $(LufDiv).append(`<a class='dl' href="${data}" download>הורד קובץ</a>`)
        }

        function PostDocError(err) {
            //faild of uploaf file of student;
            $('.loader').hide();
            swal('העלאת קובץ נכשלה')
        }
        
        function ckReplace() {
            //connect all text area to CKeditor;
            var areas = $(".ckeditor");
            $.each(areas, function (i, area) {
                CKEDITOR.replace(area, {
                    customConfig: '/Scripts/ckeditor/config.mini.js'
                });
            });
        }

        function uploadeForm() {
            //submit quiz of student

            let obj;
            questionsHolder = $(".qu");

            for (q in el.Question) {

                if ($(questionsHolder[q]).attr('Qtype') == 'O') {

                    el.Question[q].AnsContent = CKEDITOR.instances[$(questionsHolder[q]).find(`#ck${q}`).attr("id")].getData();

                } else if ($(questionsHolder[q]).attr('Qtype') == 'A' || $(questionsHolder[q]).attr('Qtype') == 'M') {
                    ansId = []
                    ans = []
                    $("#" + q + ' input:checked').each(function () {
                        ans.push($(this));
                    });

                    for (i = 0; i < ans.length; i++) {
                        ansId.push(parseInt($(ans[i]).attr("ansID")));
                    }
                    for (a in el.Question[q].Answer) {
                        if (ansId.indexOf(el.Question[q].Answer[a].AnsId) != -1) {
                            el.Question[q].Answer[a].IsPicked = true;
                        } else {
                            el.Question[q].Answer[a].IsPicked = false;
                        }

                    }
                } else if ($(questionsHolder[q]).attr('Qtype') == 'U') {

                    el.Question[q].Content = $($(questionsHolder[q])).find('.link').text();

                }
            }

            if (modeQuiz == 'new') {
                tit = el.Title;
                el.Title = userOBJ.Mail;
                ajaxCall('POST', '../api/Student/postQ', JSON.stringify(el), postQSuccess, postQError);
                el.Title=tit;
            } else if (mode == 'edit') {
                tit = el.Title;
                el.Title = userOBJ.Mail;//save the mail of user submitter
                ajaxCall('PUT', '../api/Student/updateQ', JSON.stringify(el), postQSuccess, postQError);
                el.Title=tit;//return the original title
            }

        }

        function postQSuccess(data) {
            //the quiz saved succesfully;

            swal({

                title: "מטלה נשמרה במערכת",
                icon: "success",
            })
                .then(function (confirm) {
                    if (confirm) window.history.back();
                    else window.history.back();
                })

        }

        function postQError(err) {
            //failed save quiz
            swal("משהו השתבש בניסיון לשמור את המשימה")
        }

        function getId(url) {
            //you tube link creator;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);

            return (match && match[2].length === 11)
                ? match[2]
                : null;
        }

        function connectCHK() {
            //connect all checkboxs
            $("input:checkbox").on('click', function () {
                // in the handler, 'this' refers to the box clicked on
                var $box = $(this);
                if ($box.is(":checked")) {
                    // the name of the box is retrieved using the .attr() method
                    // as it is assumed and expected to be immutable
                    var group = "input:checkbox[name='" + $box.attr("name") + "']";
                    // the checked state of the group/box on the other hand will change
                    // and the current value is retrieved using .prop() method
                    $(group).prop("checked", false);
                    $box.prop("checked", true);
                } else {
                    $box.prop("checked", false);
                }
            });
        }


    </script>

</head>
<body dir="rtl" onload="init()">
    <div id="bg"></div>
    <div id="container">
        <div id="header">
            <h1>QUIZ</h1>
        </div>

    </div>
</body>
</html>