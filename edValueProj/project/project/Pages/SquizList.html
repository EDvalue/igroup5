<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="https://unpkg.com/ionicons@5.0.0/dist/ionicons.js"></script>
    <link href="../CSS/newQuiz.css" rel="stylesheet" />
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <link href="../CSS/SquizList.css" rel="stylesheet" />
    <link href="../CSS/scrollbar.css" rel="stylesheet" />


    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script>
        var userOBJ;
        var pArr = [];
        var IPoints;
        var selectedTask;
        var cq_activeTask;
        var NactiveArr = [], activeOpenArr = [], activeCloseArr = [], allTask = [];

        $(document).ready(function () {
            $("#Nactive,#activeO,#activeC,#ch_q_div").hide();
            userOBJ = JSON.parse(localStorage["user"]);
            teamOBJ = JSON.parse(localStorage["active_student_team"]);

            userEmail = userOBJ.Mail.replace(".", ",");
            getTask = userEmail + "_" + teamOBJ.Id;



            // user = JSON.parse(localStorage["user"]);
            //bodymail = user.Mail.split(".")[0];
            //endmail = user.Mail.split(".")[1];
            //userEmail = bodymail + "," + endmail;




            //ajaxCall("GET", "../api/Student/getIntelliByMail/" + userEmail, "", ConectSuccess, ConectError)
            //console.log(IPoints)

            ajaxCall("GET", "../api/Student/getSTasks/" + getTask, "", getSTasksSuccess, getSTasksError)

        });

        function getSTasksSuccess(data) {
            console.log(data);
            allTask = data;
            for (x in data) {
                if (data[x].Task.Grade == 0) {

                    NactiveArr.push(data[x])
                } else if (new Date(data[x].TillDate) < new Date()) {

                    activeOpenArr.push(data[x])
                } else { activeCloseArr.push(data[x]) }
            }

            printNactive(NactiveArr);
            printActiveOpen(activeOpenArr);
            printActiveClose(activeCloseArr);

            $("#Nactive,#activeO,#activeC").show();
            $("#activeC .cq").hide();
            $("#activeO .cq").click(changeQ);

        }

        function changeQ() {

            taskId = this.getAttribute('task');
            qId = this.getAttribute('quiz');
            str = "";
            for (rt in activeOpenArr) {
                if (activeOpenArr[rt].Task.TaskId == taskId) {
                    cq_activeTask = activeOpenArr[rt];
                    for (q in activeOpenArr[rt].Task.QuizList) {
                        str += `<div class="cq_questionnaire">
                                  <img quizNum="${q}" quiz="${activeOpenArr[rt].Task.QuizList[q].QuestionnairId}" src="../images/${activeOpenArr[rt].Task.QuizList[q].Inteligence.Ename}.png" />
                                </div>`
                    }

                    $("#ch_q_div").html(str);
                    $("#ch_q_div").slideDown("slow");
                    $(".cq_questionnaire>img").click(confirmChange)
                }
            }

        }

        function confirmChange() {
              val = this;
                swal({

                 title: " ?האם אתה בטוח",
                 text:"העבודה שביצעת בשאלון הנוכחי תמחק!",
                  icon: "warning",
                    buttons: true,
                    dangerMode: true
                })
                 .then(function (confirm) {
                     if (confirm) {
                         cq_activeTask.Task.QuizList[val.getAttribute("quizNum")].TaskId = 2;
                         title = cq_activeTask.Task.Title;
                         cq_activeTask.Task.QuizList[val.getAttribute("quizNum")].Title = userOBJ.Mail;
                         ajaxCall("PUT","../api/Student/changeQ",JSON.stringify(cq_activeTask),changeQSuccess,changeQError)
                         cq_activeTask.Task.Title = title;

                     }
                     else {

                         swal({

                             title: "לא בוצעו שינויים",
                             icon: "info",
                         })
                     }
                 })
        }


        function changeQSuccess(data) {
            console.log(data)
            var quizC;
            for (k in cq_activeTask.Task.QuizList) {
                if (cq_activeTask.Task.QuizList[k].TaskId == 1) {
                    cq_activeTask.Task.QuizList[k].TaskId = cq_activeTask.Task.TaskId;
                } else if (cq_activeTask.Task.QuizList[k].TaskId == 2) {
                    cq_activeTask.Task.QuizList[k].TaskId = 1;
                    cq_activeTask.Task.QuizList[k].Title = cq_activeTask.Task.Title;
                    quizC=cq_activeTask.Task.QuizList[k];
                }
            }

            localStorage["quiz"] = JSON.stringify(quizC);
            localStorage["perform_showQuiz_mode"] = "student";
            localStorage['quiz_mode'] = "new";
            location.assign("showQuiz.html");
        }

        function changeQError(err) {
            console.log(err)
        }

        function printNactive(data) {
            str = "";
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour:'numeric',minute:'numeric' };
            for (x in data) {
                str += `
                     <div id="Task" class="col-lg-4">

                        <div class="content_new">
                            <div class="name_date">
                                <p>${data[x].Task.Title}</p>

                                <p>עבור:</p><span>${new Date(data[x].ForDate).toLocaleDateString(undefined, options)}</span> <ion-icon name="caret-back-outline"></ion-icon>
                            </div>

                            <div id="intelliO" class="imgQuiz">`
                for (i in data[x].Task.QuizList) {
                    str += `<img title="פתח לביצוע" onclick="chooseQuestionnaire(this,NactiveArr,'new')" task="${data[x].Task.TaskId}" quiz="${data[x].Task.QuizList[i].QuizID}" src="../images/${data[x].Task.QuizList[i].Inteligence.Ename}.png" />`
                }

                str += ` </div>
                            <div id="ladder">
                                <p>מומלץ מאוד</p>
                                <ion-icon name="analytics-outline" size="large"></ion-icon>
                                <p>פחות מומלץ</p>

                            </div>
                        </div>


                    </div>`;

            }
            $("#Nactive #tasks").text("")
            $("#Nactive #tasks").append(str)
        }

        function printActiveOpen(data) {
            str = "";
            for (x in data) {
                var num = getQnum(data[x].Task)
                str += str = createSmallTask(data[x], 'O', num);

            }
            $("#activeO #tasks").text("")
            $("#activeO #tasks").append(str)
        }
        function getQnum(arg) {

            for (a in arg.QuizList) {
                if (arg.QuizList[a].TaskId == 1) {

                    return a;
                }
            }
        }
        function printActiveClose(data) {
            str = "";

            for (x in data) {

                var num = getQnum(data[x].Task)
                str += createSmallTask(data[x], 'C', num);

            }
            $("#activeC #tasks").text("")
            $("#activeC #tasks").append(str)
        }

        function createSmallTask(data, arg, num) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour:'numeric',minute:'numeric' };
            str = `<div id="SmallTask" class="col-lg-4">

                        <div class="content_active">
                            <div class="right">
                                <div class="Name">
                                    <p>${data.Task.Title}</p>
                                </div>
                                <div class="Time">
                                    <p>${new Date(data.TillDate).toLocaleDateString(undefined, options)}</p><ion-icon class='color${arg}' name="caret-back"></ion-icon>
                                </div>
                                <div class="opt">
                                    <div class="fb">
                                        <ion-icon name="checkmark" class='color${arg}' size="large"></ion-icon>
                                        <p>צפה במשוב</p>
                                    </div>
                                   <div task="${data.Task.TaskId}" quiz="${data.Task.QuizList[num].QuizID}" class="cq">
                                        <ion-icon name="repeat" class='color${arg}' size="large"></ion-icon>

                                        <p>החלף שאלון</p>
                                    </div>
                                </div>
                            </div>
                            <div id="left">
                                <div class="classDate">
                                    <p>${new Date(data.ForDate).toLocaleDateString(undefined, options)}</p>
                                </div>
                                <div class="imgQuestionnire">`;
            if (arg == 'O') {
                str += ` <img title="פתח לביצוע" onclick="chooseQuestionnaire(this,activeOpenArr,'edit')" task="${data.Task.TaskId}" quiz="${data.Task.QuizList[num].QuizID}" src="../images/${data.Task.QuizList[num].Inteligence.Ename}.png" />`
            } else {
                str += `<img title="צפייה" task="${data.Task.TaskId}" quiz="${data.Task.QuizList[num].QuizID}" onclick="chooseQuestionnaire(this,activeCloseArr,'watch')" src="../images/${data.Task.QuizList[num].Inteligence.Ename}.png" />`
            }

            str += ` </div>

                            </div>
                        </div>
                    </div>`
            return str;

        }

        function chooseQuestionnaire(val, arr, mode) {
            localStorage["perform_showQuiz_mode"] = "student";
            localStorage['quiz_mode'] = mode;
            selectedTask = val;
            title = "";
            if (mode != "watch") {

                for (rt in allTask) {

                    if (allTask[rt].Task.TaskId == selectedTask.getAttribute('task')) {
                        title = allTask[rt].Task.Title;
                        validate = allTask[rt];
                        validate.Task.Title = userOBJ.Mail;

                        ajaxCall("PUT", "../api/Student/validateTime", JSON.stringify(validate), validateTimeSuccess, validateTimeError)
                        allTask[rt].Task.Title = title;
                        break;
                    }
                }
            } else {

                for (t in arr) {
                    if (arr[t].Task.TaskId == selectedTask.getAttribute('task')) {

                        for (q in arr[t].Task.QuizList) {
                            if (arr[t].Task.QuizList[q].QuizID == selectedTask.getAttribute('quiz')) {
                                arr[t].Task.QuizList[q].Title = arr[t].Task.Title;
                                arr[t].Task.QuizList[q].TaskId = arr[t].Task.TaskId;
                                localStorage["quiz"] = JSON.stringify(arr[t].Task.QuizList[q]);

                                location.assign("showQuiz.html");
                                break;
                            }
                        }
                    }
                }

            }





        }

        function validateTimeSuccess(data) {
            arr = allTask;
            if (!data) {

                for (t in arr) {
                    if (arr[t].Task.TaskId == selectedTask.getAttribute('task')) {

                        for (q in arr[t].Task.QuizList) {
                            if (arr[t].Task.QuizList[q].QuizID == selectedTask.getAttribute('quiz')) {
                                arr[t].Task.QuizList[q].Title = arr[t].Task.Title;
                                arr[t].Task.QuizList[q].TaskId = arr[t].Task.TaskId;
                                localStorage["quiz"] = JSON.stringify(arr[t].Task.QuizList[q]);

                                location.assign("showQuiz.html");
                                break;
                            }
                        }
                    }
                }


            } else {

                swal({

                    title: "המשימה סגורה לביצוע",
                    icon: "warning",
                })
                    .then(function (confirm) {
                        if (confirm) location.reload();
                        else location.reload();;
                    })
            }

        }

        function validateTimeError(err) {

        }

        function getSTasksError(err) {
            console.log(err);
        }

        function ConectSuccess(data) {
            console.log(data);

            IPoints = data;
            IPoints.sort(function (a, b) {
                return a.Points - b.Points
            })
            console.log(IPoints);
            var str = "";
            for (var i = 5; i > -1; i--) {
                str += "<img src='../images/" + IPoints[i].Name + "N.jpg'/>"
            }
            console.log(str);
            document.getElementById("intelliO").innerHTML = str;

        }

        function ConectError(err) {
            console.log(err)
        }


    </script>


</head>
<body dir="rtl">
    <div id="ch_q_div"></div>
    <div id="container">

        <div id="header" class="row">

            <div id="imgLogo" class="col-lg-3">

                <img src="../images/EDvalueSmall.png" />

            </div>

            <div id="title" class="col-lg-6">
                <h1>המשימות שלי‍</h1>
                <p>בחר משימה מתאימה</p>
            </div>

            <div id="mindcetImg" class="col-lg-3">
                <!--<img src="../images/MindCet.png" />-->
            </div>

        </div>


        <div id="Nactive">

            <div id="NacTitle">
                <h3>משימות חדשות </h3>
            </div>

            <div id="tasks" class="row">

                <div id="Task" class="col-lg-4">

                    <div class="content_new">
                        <div class="name_date">
                            <p>שם משימה</p>

                            <p>עבור:</p><span>22/05/2020</span> <ion-icon name="caret-back-outline"></ion-icon>
                        </div>

                        <div id="intelliO" class="imgQuiz">

                            <img src="../images/MovementalN.jpg" />
                            <img src="../images/SpatialN.jpg" />
                            <img src="../images/tongueN.jpg" />
                            <img src="../images/musicallyN.jpg" />
                            <img src="../images/PersonalN.jpg" />
                            <img src="../images/logicallyN.jpg" />
                        </div>
                        <div id="ladder">
                            <p>מומלץ מאוד</p>
                            <ion-icon name="analytics-outline" size="large"></ion-icon>
                            <p>פחות מומלץ</p>

                        </div>
                    </div>


                </div>



            </div>

        </div>


        <div id="activeO">

            <div id="acTitle">
                <h3>משימות פעילות</h3>
            </div>

            <div id="tasks" class="row">

                <div id="Task" class="col-lg-4">

                    <div class="content_active">
                        <div class="right">
                            <div class="Name">
                                <p>שם משימה....</p>
                            </div>
                            <div class="Time">
                                <p>לתאריך:22.22.2222</p><ion-icon name="caret-back-outline"></ion-icon>
                            </div>
                            <div class="opt">
                                <div class="fb">
                                    <ion-icon name="checkmark-outline" size="large"></ion-icon>
                                    <p>צפה במשוב</p>
                                </div>
                                <div class="cq">
                                    <ion-icon name="repeat-outline" size="large"></ion-icon>
                                    <p>החלף שאלון</p>
                                </div>
                            </div>
                        </div>
                        <div id="left">
                            <div class="classDate">
                                <p>22.22.2222</p>
                            </div>
                            <div class="imgQuestionnire">

                                <img src="../images/תנועתית ללא שם.jpg" />

                            </div>
                        </div>
                    </div>
                </div>


            </div>


        </div>

        <div id="activeC">

            <div id="acTitle">
                <h3>משימות שעברו</h3>
            </div>

            <div id="tasks" class="row">

                <div id="Task" class="col-lg-4">

                    <div class="content_active">
                        <div class="right">
                            <div class="Name">
                                <p>שם משימה....</p>
                            </div>
                            <div class="Time">
                                <p>לתאריך:22.22.2222</p><ion-icon name="caret-back-outline"></ion-icon>
                            </div>
                            <div class="opt">
                                <div class="fb">
                                    <ion-icon name="checkmark-outline" size="large"></ion-icon>
                                    <p>צפה במשוב</p>
                                </div>
                                <div class="cq">
                                    <ion-icon name="repeat-outline" size="large"></ion-icon>
                                    <p>החלף שאלון</p>
                                </div>
                            </div>
                        </div>
                        <div id="left">
                            <div class="classDate">
                                <p>22.22.2222</p>
                            </div>
                            <div class="imgQuestionnire">

                                <img src="../images/תנועתית ללא שם.jpg" />

                            </div>
                        </div>
                    </div>
                </div>

                <div id="Task" class="col-lg-4">

                    <div class="content_active">
                        <div class="right">
                            <div class="Name">
                                <p>שם משימה....</p>
                            </div>
                            <div class="Time">
                                <p>לתאריך:22.22.2222</p><ion-icon name="caret-back-outline"></ion-icon>
                            </div>
                            <div class="opt">
                                <div class="fb">
                                    <ion-icon name="checkmark-outline" size="large"></ion-icon>
                                    <p>צפה במשוב</p>
                                </div>
                                <div class="cq">
                                    <ion-icon name="repeat-outline" size="large"></ion-icon>
                                    <p>החלף שאלון</p>
                                </div>
                            </div>
                        </div>
                        <div id="left">
                            <div class="classDate">
                                <p>22.22.2222</p>
                            </div>
                            <div class="imgQuestionnire">

                                <img src="../images/תנועתית ללא שם.jpg" />

                            </div>
                        </div>
                    </div>
                </div>

                <div id="Task" class="col-lg-4">

                    <div class="content_active">
                        <div class="right">
                            <div class="Name">
                                <p>שם משימה....</p>
                            </div>
                            <div class="Time">
                                <p>לתאריך:22.22.2222</p><ion-icon name="caret-back-outline"></ion-icon>
                            </div>
                            <div class="opt">
                                <div class="fb">
                                    <ion-icon name="checkmark-outline" size="large"></ion-icon>
                                    <p>צפה במשוב</p>
                                </div>
                                <div class="cq">
                                    <ion-icon name="repeat-outline" size="large"></ion-icon>
                                    <p>החלף שאלון</p>
                                </div>
                            </div>
                        </div>
                        <div id="left">
                            <div class="classDate">
                                <p>22.22.2222</p>
                            </div>
                            <div class="imgQuestionnire">

                                <img src="../images/תנועתית ללא שם.jpg" />

                            </div>
                        </div>
                    </div>
                </div>

                <div id="Task" class="col-lg-4">

                    <div class="content_active">
                        <div class="right">
                            <div class="Name">
                                <p>שם משימה....</p>
                            </div>
                            <div class="Time">
                                <p>לתאריך:22.22.2222</p><ion-icon name="caret-back-outline"></ion-icon>
                            </div>
                            <div class="opt">
                                <div class="fb">
                                    <ion-icon name="checkmark-outline" size="large"></ion-icon>
                                    <p>צפה במשוב</p>
                                </div>
                                <div class="cq">
                                    <ion-icon name="repeat-outline" size="large"></ion-icon>
                                    <p>החלף שאלון</p>
                                </div>
                            </div>
                        </div>
                        <div id="left">
                            <div class="classDate">
                                <p>22.22.2222</p>
                            </div>
                            <div class="imgQuestionnire">

                                <img src="../images/תנועתית ללא שם.jpg" />

                            </div>
                        </div>
                    </div>
                </div>





            </div>


        </div>


    </div>

</body>
</html>