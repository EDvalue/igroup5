<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link href="../CSS/manageClass.css" rel="stylesheet" />
    <link href="../CSS/newQuiz.css" rel="stylesheet" />
    <link href="../CSS/myClass.css" rel="stylesheet" />
    <link href="../CSS/scrollbar.css" rel="stylesheet" />
    <script src="../js/js.js"></script>
    <title></title>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@0.5.7/chartjs-plugin-annotation.min.js"></script>
    <script src="../js/Graphs.js"></script>
    <script>

        var userOBJ;
        var SignIn;
        var classPage;
        var graphData;
        var graphObject = {
            taskArr: [],
            intelligenceArr: [],
            stArr: [],
            subj: [],
        };

        var sortTags = {
            taskArr: [],
            intelligenceArr: [],
            stArr: [],
            subj: [],
        }
        var sortedGraphData;

        $(document).ready(function () {
            if (localStorage["user"]) {
                userOBJ = JSON.parse(localStorage["user"]);
                $("#user_manage>button").append(userOBJ.Name + " " + userOBJ.LastName);
            }

            if (localStorage["Teacher_inClass"])
                classPage = JSON.parse(localStorage["Teacher_inClass"]);

            $("#title h3").html(classPage.Name)
            info = {
                GradeClass: classPage.Grade,
                ClassNumber: classPage.GradeNumber,
                SchoolCode: classPage.InSchool,
            }

            ajaxCall("PUT", '../api/Teacher/getGraphClassData', JSON.stringify(info), getGraphClassDataSuccess, getGraphClassDataError)
            $('#mySelect').change().val('TaskCharts').trigger('change');
        });

        function getGraphClassDataSuccess(data) {
            console.log(data);
            graphData = data;
            sortedGraphData = data;

            info = {
                GradeClass: classPage.Grade,
                ClassNumber: classPage.GradeNumber,
                SchoolCode: classPage.InSchool,
            }
             ajaxCall("PUT", '../api/Teacher/intlClassGraph', JSON.stringify(info), intlClassGraphSuccess, intlClassGraphError)
            sortDivs();
            UpdateTaskDoughnut();
            GradesAvgChart()
            PercentageChart();
            ChartIntl();
        }

        function intlClassGraphSuccess(data) {
            console.log(data);
            sortDivs();
            UpdateTaskDoughnut();
            GradesAvgChart()
            PercentageChart();

        }

        function intlClassGraphError(err) {
            console.log(err);
        }

        function sortDivs() {
            var intl = {};
            var taskName = {};
            var st = {};
            var sub = {};
            var flag = 0;
            for (x in graphData) {

                if (graphData[x].isperform == 1) {
                    if (!intl[graphData[x].IntelligenceName])
                        graphObject.intelligenceArr.push(graphData[x].IntelligenceName);
                    intl[graphData[x].IntelligenceName] = graphData[x].IntelligenceName;
                }
                else {
                    graphData[x].IntelligenceName = "לא ביצעו"
                    intl["לא ביצעו"] = "לא ביצעו"
                    if (!flag)
                        graphObject.intelligenceArr.push("לא ביצעו");
                    flag = 1;
                }
                if (!taskName[graphData[x].TaskTitle]) {
                    taskName[graphData[x].TaskTitle] = graphData[x].TaskTitle;
                    graphObject.taskArr.push(graphData[x].TaskTitle)
                }
                if (!st[graphData[x].Mail]) {
                    st[graphData[x].Mail] = graphData[x].Mail;
                    graphObject.stArr.push(graphData[x].Mail)
                }
                if (!sub[graphData[x].SubjectName]) {
                    sub[graphData[x].SubjectName] = graphData[x].SubjectName;
                    graphObject.subj.push(graphData[x].SubjectName)
                }

            }
            printIntelligence(intl);
            printTaskName(taskName);
            printSubj(sub);
            printSt(st);
        }

        function printSt(obj) {
            var str = "";
            for (x in obj) {
                str += `<div id="${x}"><input type="checkbox" onchange="sortGraphData('stArr',this)" /><span>${x}</span></div>`
            }
            $("#stList").append(str);
        }
        function printSubj(obj) {
            var str = "";
            for (x in obj) {
                str += `<div id="${x}"><input type="checkbox" onchange="sortGraphData('subj',this)" /><span>${x}</span></div>`
            }
            $("#subjectsList").append(str);
        }
        function printIntelligence(obj) {
            var str = "";
            for (x in obj) {
                str += `<div id="${x}"><span>${x}</span><input type="checkbox" onchange="sortGraphData('intelligenceArr',this)" /></div>`
            }
            $("#IntelligenceCheckBox").append(str);
        }
        function printTaskName(obj) {
            var str = "";
            for (x in obj) {
                str += `<div id="${x.replace(`"`, "")}"><input type="checkbox" onchange="sortGraphData('taskArr',this)" /><span>${x}</span></div>`
            }
            $("#taskName").append(str)
        }

        function sortGraphData(arrName, val) {
               $("#statistics input[type='checkbox']").attr('disabled','disabled')
            setTimeout(function(){ $("#statistics input[type=checkbox]").attr('disabled',false); }, 1100);
            sortedGraphData = [];
            var valID = val.parentNode.id;
            var isChecked = $(val).prop("checked");

            if (isChecked) {
                sortTags[arrName].push(valID)
            }
            else {
                if (sortTags[arrName].indexOf(valID) != -1) {
                    var index = sortTags[arrName].indexOf(valID);
                    sortTags[arrName].splice(index, 1)
                }

            }
            var arr = $("#main input:checked")
            if (arr.length > 0) {
                for (x in graphData) {

                    if ((sortTags["intelligenceArr"].indexOf(graphData[x].IntelligenceName) != -1 || sortTags["taskArr"].indexOf(graphData[x].TaskTitle.replace(`"`, "")) != -1) || sortTags["stArr"].indexOf(graphData[x].Mail) != -1 || sortTags["subj"].indexOf(graphData[x].SubjectName) != -1) {
                        sortedGraphData.push(graphData[x])
                    }
                }
                console.log(sortedGraphData)
                task.data.datasets = sortedGraphData
                gradesAvgChart.data.datasets = sortedGraphData
                IntPercentageChart.data.datasets = sortedGraphData
                UpdateTaskDoughnut()
                GradesAvgChart()
                PercentageChart()
            } else {

                sortedGraphData = graphData;
                console.log(sortedGraphData)
                task.data.datasets = sortedGraphData
                gradesAvgChart.data.datasets = sortedGraphData
                IntPercentageChart.data.datasets = sortedGraphData
                UpdateTaskDoughnut()
                GradesAvgChart()
                PercentageChart()

            }

        }

        function getGraphClassDataError(err) {
            console.log(err);
        }

        function confirmSignIn() {
            swal({
                title: "האם אתה בטוח",
                text: "ההרשמה לכיתה תפתח למשך 15 דקות",
                icon: "warning",
                buttons: [
                    'לא,בטל פעולה!',
                    'כן,אני בטוח'
                ],
                dangerMode: true,
            }).then(function (isConfirm) {
                if (isConfirm) {

                    OpenSignIn()

                } else {
                    swal("פתיחת הרשמה בוטלה", "❌");
                }
            })

        }
        function OpenSignIn() {

            SignIn = {

                Code: new Date().getTime() + userOBJ.IdNumber,
                Time: new Date(),
                Grade: classPage.Grade,
                GradeNumber: classPage.GradeNumber,
                School: classPage.InSchool,
                Mail: userOBJ.Mail,
                Title: classPage.Name,
            }

            ajaxCall("PUT", "../api/Teacher/openSI", JSON.stringify(SignIn), openSIsuccess, openSIerror)

        }

        function openSIsuccess(data) {
            swal({
                title: 'הרשמה נפתחה!',
                text: `כעת ניתן להירשם באמצעות הקוד:${SignIn.Code}`,
                icon: 'success'
            });

        }

        function openSIerror(err) { }

        function ChartChange() {
            $("#statistics").height("400px")
            var x = document.getElementById("mySelect").value;
            var AverageCharts = document.getElementById("AverageCharts");
            var TaskCharts = document.getElementById("TaskCharts");
            var GradeCharts = document.getElementById("GradeCharts");
            var PercentageCharts = document.getElementById("PercentageCharts")
            var intlCharts = document.getElementById("intlCharts");
            if (x == "AverageCharts") {

                AverageCharts.style.display = "block";
                TaskCharts.style.display = "none";
                GradeCharts.style.display = "none";
                PercentageCharts.style.display = "none";
                intlCharts.style.display = "none";
            }
            else if (x == "TaskCharts") {

                AverageCharts.style.display = "none";
                TaskCharts.style.display = "block";
                GradeCharts.style.display = "none";
                PercentageCharts.style.display = "none";
                intlCharts.style.display = "none";
            }
            else if (x == "GradeCharts") {

                AverageCharts.style.display = "none";
                TaskCharts.style.display = "none";
                GradeCharts.style.display = "block";
                PercentageCharts.style.display = "none";
                intlCharts.style.display = "none";
            }
            else if (x == "PercentageCharts") {

                AverageCharts.style.display = "none";
                TaskCharts.style.display = "none";
                GradeCharts.style.display = "none";
                PercentageCharts.style.display = "block";
                intlCharts.style.display = "none";
            }
            else if (x == "intlCharts") {
                AverageCharts.style.display = "none";
                TaskCharts.style.display = "none";
                GradeCharts.style.display = "none";
                PercentageCharts.style.display = "none";
                intlCharts.style.display = "block";
            }
            else {

                AverageCharts.style.display = "none";
                TaskCharts.style.display = "none";
                GradeCharts.style.display = "none";
                PercentageCharts.style.display = "none";
                intlCharts.style.display = "none";
            }

        }
    </script>
</head>
<body dir="rtl">
    <div id="disbackg"></div>
    <div id="container">
        <div id="header">
            <div class="row">

                <div id="imgLogo" class="col-lg-3">

                    <img src="../images/EDvalueSmall.png" />

                </div>

                <div id="title" class="col-lg-6">
                    <h3>שם הקבוצה...</h3>

                </div>

                <div id="mindcetImg" class="col-lg-3 d-none d-lg-block">

                    <!--<img src="../images/MindCet.png" />-->

                </div>

            </div>

            <nav class="navbar navbar-expand-lg navbar-light navBar">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>


                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav navPadding">
                        <li class="nav-item active">
                            <div id="open_signIn">
                                <input type="button" class="btn btn-primary" onclick="confirmSignIn()" value="פתח רישום" />
                            </div>
                        </li>
                    </ul>
                  
                    <select class="btn btn-primary btnonSmall" id="mySelect" onchange="ChartChange()">
                        <option value="" disabled selected hidden>בחר גרף</option>
                        <option value="TaskCharts">גרף הגשות</option>
                        <option value="GradeCharts">גרף ממוצעי ציונים</option>
                        <option value="PercentageCharts">אחוזי אינטלגנציות</option>
                        <option value="intlCharts">ניקוד אינטליגנציות</option>
                        <option value="CloseAll">לסגור הכל</option>
                    </select>
                </div>


                <div id="user_manage">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                    </button>
                    <div id="nav_cnt" class="dropdown-menu">
                        <p id="disconnect" onclick="disconnect()">התנתק</p>
                        <p id="cp" onclick="displayCP()">שנה סיסמא</p>
                    </div>
                </div>
            </nav>
        </div>

        <div id="main">

            <div id="statistics">
                <div id="stat_control_top">
                    <div class="capr"></div>
                    <div id="IntelligenceCheckBox">
                    </div>
                    <div class="capl"></div>
                </div>

                <div id="mainGraph">
                    <div id="stat_control_right">

                        <div id="slTitle">
                            <h4>תלמידים</h4>
                        </div>
                        <div id="stList">



                        </div>

                    </div>
                    <div class="content">
                        <div class="row" id="intlCharts" style="display:none">
                            <h3 style="text-align:center">
                                גרף זה לא מסונן
                            </h3>
                            <div class="wrapper col-12"><canvas id="intlChart"></canvas></div>

                        </div>
                        <div class="row" id="AverageCharts" style="display:none">
                            <div class="wrapper col-12"><canvas id="AverageChart"></canvas></div>

                        </div>
                        <div class="row" id="TaskCharts" style="display:none">

                            <div class="wrapper col-12"><canvas id="TaskChart"></canvas></div>

                        </div>
                        <div class="row" id="GradeCharts" style="display:none">

                            <div class="wrapper col-12"><canvas id="GradeChart"></canvas></div>

                        </div>
                        <div class="row" id="PercentageCharts" style="display:none">

                            <div class="wrapper col-12"><canvas id="PercentageChart"></canvas></div>

                        </div>
                    </div>


                    <div id="stat_control_left">
                        <div id="taskName">

                        </div>
                        <div id="subjectsList">

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</body>
</html>